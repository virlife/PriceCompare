{% extends 'base.html' %}

{% block title %}比价系统 - 首页{% endblock %}


{% block content %}

    <div class="container-fluid block-menu">
        <div class="row-fluid">
            <div class="pull-left">
                <ul class="nav nav-tabs">
                    <li><a href="#Home" data-toggle="tab"><i class="icon-home"></i> 主页</a></li>
                    <li><a href="#Taobao" data-toggle="tab">淘宝</a></li>
                    <li><a href="#Amazon" data-toggle="tab">亚马逊</a></li>
                    <li><a href="#Jingdong" data-toggle="tab">京东</a></li>
                    <li><a href="#Dangdang" data-toggle="tab">当当</a></li>
                </ul>
            </div>


            <div class="btn-group pull-right">
                <button id="sort-btn" class="btn btn-info dropdown-toggle" data-toggle="dropdown">
                    商品排序： <i class="icon-chevron-down"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="sort-id">名称</a></li>
                    <li><a class="sort-id">价格（升序）</a></li>
                    <li><a class="sort-id">价格（降序）</a></li>
                </ul>

            </div>

            <div class="btn-group pull-right">

                <button id="num-btn" class="btn btn-info dropdown-toggle" data-toggle="dropdown">
                    每页数量： <i class="icon-chevron-down"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="num-id">9</a></li>
                    <li><a class="num-id">18</a></li>
                    <li><a class="num-id">27</a></li>
                </ul>
            </div>


        </div>

    </div>


    <div class=" container-fluid block-content">


        <div class="tab-content">
            <div class="tab-pane" id="Home">


            </div>
            <div class="tab-pane" id="Taobao">


            </div>
            <div class="tab-pane" id="Amazon">


            </div>
            <div class="tab-pane" id="Jingdong">

            </div>
            <div class="tab-pane" id="Dangdang">


            </div>
        </div>


    </div>



    <script type="text/javascript">

        window['search_query'] = '';
        window['sort'] = '名称';
        window['num'] = 9;


        // 核心函数，用于向服务器本地数据库查询商品
        function search() {

            // 生成排序参数
            var sort;
            if (window['sort'] == '价格（升序）')
                sort = 'price';
            else if (window['sort'] == '价格（降序）')
                sort = '-price';
            else
                sort = 'name';

            // 生成站点来源参数
            var site = $(".tab-pane.active").attr("id");

            $(".tab-pane.active").load(
                    "/ajax/search/",
                    {
                        search_query: window['search_query'],
                        sort: sort,
                        num: window['num'],
                        site: site
                    },
                    function (data) {
                        $(this).html(data);

                        $('.carousel').carousel();
                    });

        }

        //用于检索互联网以更新数据库
        function update() {

            // 提示用户正在更新
            var msg = $.globalMessenger().post({
                message: '您看到的是目前我们本地数据库里的商品信息，后台正在努力为您检索最新的相关商品，请耐心等待，谢谢！',
                type: 'info',
                showCloseButton: true,
                actions: {
                    confirm: {
                        label: '好的',
                        action: function () {
                            msg.hide();
                        }
                    }

                }
            });

            $.post(
                    "/ajax/update/",
                    {
                        search_query: window['search_query']
                    },
                    function (data, status, xhr) {
                        // 如果返回222,表示更新完毕，再次执行搜索
                        if (xhr.status == '222') {
                            // 弹出提示窗口
                            var msg = $.globalMessenger().post({
                                message: '您所检索的商品信息已更新，是否立即重新搜索？',
                                type: 'success',
                                showCloseButton: true,
                                actions: {
                                    confirm: {
                                        label: '确定',
                                        action: function () {
                                            search();
                                            msg.hide();
                                        }
                                    },

                                    cancel: {
                                        label: '取消',
                                        action: function () {
                                            msg.hide();
                                        }
                                    }

                                }
                            });
                        }


                    }
            );


        }


        // 页面加载完毕开始执行
        $(document).ready(function () {

            // 激活主页
            $('.nav-tabs li:first').addClass('active');
            $('#Home').addClass("active");

            // 设定消息通知属性
            $._messengerDefaults = {
                extraClasses: 'messenger-fixed messenger-theme-future messenger-on-bottom'
            }

            // 是否通过搜索跳转到此页面

            if ($('#search_query').val() != '') {
                window['search_query'] = $('#search_query').val();
                update(); // 由于是首次提交关键字，向服务器请求执行跨站搜索以更新数据库
            }

            // 检索本地数据库，显示商品列表
            search();

            ///////////////
            // 下面是事件函数
            ///////////////

            // 切换不同站点的商品
            $('.nav-tabs li a').click(function () {

                setTimeout(function () {
                    search();

                }, 100);

            });

            // 重新排序

            $('.sort-id').click(function () {

                window['sort'] = $(this).text();
                $('#sort-btn').text('商品排序： ' + window['sort']);


                search();

            });


            // 设定每页数量
            $('.num-id').click(function () {

                window['num'] = $(this).text();
                $('#num-btn').text('每页数量： ' + window['num']);

                search();
            });

        });
    </script>



{% endblock %}